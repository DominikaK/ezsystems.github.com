<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/authAgents/SessionAuthAgent.js - eZ Platform JavaScript REST client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://ez.no/extension/ez_ezno/design/ezno_2014/images/ez-logo.png" title="eZ Platform JavaScript REST client"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/CAPI.html">CAPI</a></li>
                                <li><a href="../classes/CAPIError.html">CAPIError</a></li>
                                <li><a href="../classes/ConnectionFeatureFactory.html">ConnectionFeatureFactory</a></li>
                                <li><a href="../classes/ConnectionManager.html">ConnectionManager</a></li>
                                <li><a href="../classes/ContentCreateStruct.html">ContentCreateStruct</a></li>
                                <li><a href="../classes/ContentMetadataUpdateStruct.html">ContentMetadataUpdateStruct</a></li>
                                <li><a href="../classes/ContentService.html">ContentService</a></li>
                                <li><a href="../classes/ContentTypeCreateStruct.html">ContentTypeCreateStruct</a></li>
                                <li><a href="../classes/ContentTypeGroupInputStruct.html">ContentTypeGroupInputStruct</a></li>
                                <li><a href="../classes/ContentTypeService.html">ContentTypeService</a></li>
                                <li><a href="../classes/ContentTypeUpdateStruct.html">ContentTypeUpdateStruct</a></li>
                                <li><a href="../classes/ContentUpdateStruct.html">ContentUpdateStruct</a></li>
                                <li><a href="../classes/DiscoveryService.html">DiscoveryService</a></li>
                                <li><a href="../classes/extend.html">extend</a></li>
                                <li><a href="../classes/FieldDefinitionCreateStruct.html">FieldDefinitionCreateStruct</a></li>
                                <li><a href="../classes/FieldDefinitionUpdateStruct.html">FieldDefinitionUpdateStruct</a></li>
                                <li><a href="../classes/HttpBasicAuthAgent.html">HttpBasicAuthAgent</a></li>
                                <li><a href="../classes/InMemoryStorage.html">InMemoryStorage</a></li>
                                <li><a href="../classes/LocalStorage.html">LocalStorage</a></li>
                                <li><a href="../classes/LocationCreateStruct.html">LocationCreateStruct</a></li>
                                <li><a href="../classes/LocationUpdateStruct.html">LocationUpdateStruct</a></li>
                                <li><a href="../classes/MicrosoftXmlHttpRequestConnection.html">MicrosoftXmlHttpRequestConnection</a></li>
                                <li><a href="../classes/ObjectStateCreateStruct.html">ObjectStateCreateStruct</a></li>
                                <li><a href="../classes/ObjectStateGroupCreateStruct.html">ObjectStateGroupCreateStruct</a></li>
                                <li><a href="../classes/ObjectStateGroupUpdateStruct.html">ObjectStateGroupUpdateStruct</a></li>
                                <li><a href="../classes/ObjectStateUpdateStruct.html">ObjectStateUpdateStruct</a></li>
                                <li><a href="../classes/parseUriTemplate.html">parseUriTemplate</a></li>
                                <li><a href="../classes/PolicyCreateStruct.html">PolicyCreateStruct</a></li>
                                <li><a href="../classes/PolicyUpdateStruct.html">PolicyUpdateStruct</a></li>
                                <li><a href="../classes/PromiseCAPI.html">PromiseCAPI</a></li>
                                <li><a href="../classes/PromiseService.html">PromiseService</a></li>
                                <li><a href="../classes/RelationCreateStruct.html">RelationCreateStruct</a></li>
                                <li><a href="../classes/Request.html">Request</a></li>
                                <li><a href="../classes/Response.html">Response</a></li>
                                <li><a href="../classes/RoleAssignInputStruct.html">RoleAssignInputStruct</a></li>
                                <li><a href="../classes/RoleInputStruct.html">RoleInputStruct</a></li>
                                <li><a href="../classes/SectionInputStruct.html">SectionInputStruct</a></li>
                                <li><a href="../classes/SessionAuthAgent.html">SessionAuthAgent</a></li>
                                <li><a href="../classes/SessionCreateStruct.html">SessionCreateStruct</a></li>
                                <li><a href="../classes/UrlAliasCreateStruct.html">UrlAliasCreateStruct</a></li>
                                <li><a href="../classes/UrlWildcardCreateStruct.html">UrlWildcardCreateStruct</a></li>
                                <li><a href="../classes/UserCreateStruct.html">UserCreateStruct</a></li>
                                <li><a href="../classes/UserGroupCreateStruct.html">UserGroupCreateStruct</a></li>
                                <li><a href="../classes/UserGroupUpdateStruct.html">UserGroupUpdateStruct</a></li>
                                <li><a href="../classes/UserService.html">UserService</a></li>
                                <li><a href="../classes/UserUpdateStruct.html">UserUpdateStruct</a></li>
                                <li><a href="../classes/ViewCreateStruct.html">ViewCreateStruct</a></li>
                                <li><a href="../classes/XmlHttpRequestConnection.html">XmlHttpRequestConnection</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/authAgents/SessionAuthAgent.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* global define */
define([&quot;structures/CAPIError&quot;, &quot;storages/LocalStorage&quot;], function (CAPIError, LocalStorage) {
    &quot;use strict&quot;;

    /**
     * Creates an instance of SessionAuthAgent object
     *
     * Auth agent handles low level implementation of authorization workflow.
     * By providing a &#x60;login&#x60; and a &#x60;password&#x60; in the &#x60;authInfo&#x60; object, the
     * auth agent will try to create a session:
     *
     *     var SessionAuthAgent({login: &quot;admin&quot;, password: &quot;publish&quot;});
     *
     * The session auth agent is also able to reuse an existing session, to do
     * that it needs to receive an object with the session info:
     *
     *     var new SessionAuthAgent({
     *            name: &quot;eZSESSID&quot;,
     *            identifier: &quot;sessionidentifier&quot;,
     *            href: &quot;/api/ezp/v2/users/session/sessionidentifier&quot;,
     *            csrfToken: &quot;longCsrfToken&quot;,
     *        });
     *
     * @class SessionAuthAgent
     * @constructor
     * @param authInfo {Object} object literal containg the credentials (&#x60;login&#x60;
     * and &#x60;password&#x60;) or the session info of an already existing one (&#x60;name&#x60;,
     * &#x60;identifier&#x60;, &#x60;href&#x60; and &#x60;csrfToken&#x60;)
     * @param authInfo.login {String} user login
     * @param authInfo.password {String} user password
     * @param authInfo.name {String} name of the session
     * @param authInfo.identifier {String} identifier of the session
     * @param authInfo.href {String} refresh resource URI for the session
     * @param authInfo.csrfToken {String} CSRF Token
     * @param [storage=LocalStorage] {StorageAbstraction} storage to be used. By default a LocalStorage will be utilized
     */
    var SessionAuthAgent = function (authInfo, storage) {
            /**
             * The CAPI instance. It is set by the call to setCAPI() done while
             * instantiating the CAPI.
             *
             * @property _CAPI
             * @type CAPI
             * @protected
             */
            this._CAPI = null;

            /**
             * The login
             *
             * @property _login
             * @type {String}
             * @default &quot;&quot;
             * @protected
             */
            this._login = &#x27;&#x27;;

            /**
             * The password
             *
             * @property _password
             * @type {String}
             * @default &quot;&quot;
             * @protected
             */
            this._password = &#x27;&#x27;;

            /**
             * The storage to use to store the session info.
             *
             * @property _storage
             * @type {StorageAbstraction}
             * @default LocalStorage
             * @protected
             */
            this._storage = storage || new LocalStorage();

            if ( authInfo ) {
                if ( authInfo.login &amp;&amp; authInfo.password ) {
                    this.setCredentials(authInfo);
                } else if ( authInfo.csrfToken &amp;&amp; authInfo.identifier &amp;&amp; authInfo.name &amp;&amp; authInfo.href ) {
                    this._storeSessionInfo(authInfo);
                } else {
                    throw new CAPIError(&quot;Invalid authInfo parameter&quot;);
                }
            }
        },
        SAFE_METHODS = {&#x27;GET&#x27;: 1, &#x27;HEAD&#x27;: 1, &#x27;OPTIONS&#x27;: 1, &#x27;TRACE&#x27;: 1};

    /**
     * Constant to be used as storage key for the sessionName
     *
     * @static
     * @const
     * @type {string}
     */
    SessionAuthAgent.KEY_SESSION_NAME = &#x27;ezpRestClient.sessionName&#x27;;

    /**
     * Constant to be used as storage key for the sessionId
     *
     * @static
     * @const
     * @type {string}
     */
    SessionAuthAgent.KEY_SESSION_ID = &#x27;ezpRestClient.sessionId&#x27;;

    /**
     * Constant to be used as storage key for the sessionHref
     *
     * @static
     * @const
     * @type {string}
     */
    SessionAuthAgent.KEY_SESSION_HREF = &#x27;ezpRestClient.sessionHref&#x27;;

    /**
     * Constant to be used as storage key for the csrfToken
     *
     * @static
     * @const
     * @type {string}
     */
    SessionAuthAgent.KEY_CSRF_TOKEN = &#x27;ezpRestClient.csrfToken&#x27;;

    /**
     * Checks that the current user is still logged in. To be considered as
     * logged in, the storage should have a session id and the refresh calls
     * should be successful.
     * If the storage does not contain any session info, the callback is called
     * with &#x60;true&#x60; as its first argument, otherwise, the callback is called
     * with the &#x60;error&#x60; and &#x60;result&#x60; from {{#crossLink
     * &quot;UserService/refreshSession:method&quot;}}UserService.refreshSession{{/crossLink}}.
     *
     * @param {Function} callback
     * @method isLoggedIn
     */
    SessionAuthAgent.prototype.isLoggedIn = function (callback) {
        var that = this,
            userService = this._CAPI.getUserService(),
            sessionId = this._storage.getItem(SessionAuthAgent.KEY_SESSION_ID);

        if ( sessionId === null) {
            callback(true, false);
            return;
        }
        userService.refreshSession(sessionId, function (error, result) {
            if ( error ) {
                that._resetStorage();
            }
            callback(error, result);
        });
    };

    /**
     * Called every time a new request cycle is started,
     * to ensure those requests are correctly authenticated.
     *
     * A cycle may contain one or more queued up requests
     *
     * @method ensureAuthentication
     * @param done {Function} Callback function, which is to be called by the implementation to signal the authentication has been completed.
     */
    SessionAuthAgent.prototype.ensureAuthentication = function (done) {
        if (this._storage.getItem(SessionAuthAgent.KEY_SESSION_ID) !== null) {
            done(false, true);
            return;
        }

        var that = this,
            userService = this._CAPI.getUserService(),
            sessionCreateStruct = userService.newSessionCreateStruct(
                this._login,
                this._password
            );

        userService.createSession(
            sessionCreateStruct,
            function (error, sessionResponse) {
                var session;

                if (error) {
                    done(error, sessionResponse);
                    return;
                }

                session = sessionResponse.document.Session;
                that._storeSessionInfo({
                    name: session.name,
                    href: session._href,
                    identifier: session.identifier,
                    csrfToken: session.csrfToken,
                });

                done(false, sessionResponse);
            }
        );
    };

    /**
     * Tries to log in in the REST API. If the storage already contains a
     * session id, first it tries to log out before doing the log in.
     *
     * @method logIn
     * @param {Function} callback
     */
    SessionAuthAgent.prototype.logIn = function (callback) {
        var that = this;

        if ( this._storage.getItem(SessionAuthAgent.KEY_SESSION_ID) !== null ) {
            this.logOut(function (error, result) {
                that.ensureAuthentication(callback);
            });
        } else {
            this.ensureAuthentication(callback);
        }
    };

    /**
     * Hook to allow the modification of any request, for authentication purposes, before
     * sending it out to the backend
     *
     * @method authenticateRequest
     * @param request {Request}
     * @param done {Function}
     */
    SessionAuthAgent.prototype.authenticateRequest = function (request, done) {
        var token = this._storage.getItem(SessionAuthAgent.KEY_CSRF_TOKEN);

        if ( SAFE_METHODS[request.method.toUpperCase()] !== 1 &amp;&amp; token !== null ) {
            request.headers[&quot;X-CSRF-Token&quot;] = token;
        }

        done(false, request);
    };

    /**
     * Log out. If the client did not logged in yet, the callback is called with
     * &#x60;false&#x60; and &#x60;true&#x60; as arguments, otherwise the callback is called with the
     * &#x60;error&#x60; and the &#x60;result&#x60; from {{#crossLink
     * &quot;UserService/deleteSession:method&quot;}}userService.deleteSession{{/crossLink}}.
     *
     * @method logOut
     * @param done {Function}
     */
    SessionAuthAgent.prototype.logOut = function (done) {
        var userService = this._CAPI.getUserService(),
            sessionHref = this._storage.getItem(SessionAuthAgent.KEY_SESSION_HREF),
            that = this;

        if ( sessionHref === null ) {
            done(false, true);
            return;
        }

        userService.deleteSession(
            sessionHref,
            function (error, response) {
                if ( !error ) {
                    that._resetStorage();
                }
                done(error, response);
            }
        );
    };

    /**
     * Set the instance of the CAPI to be used by the agent
     *
     * @method setCAPI
     * @param CAPI {CAPI} current instance of the CAPI object
     */
    SessionAuthAgent.prototype.setCAPI = function (CAPI) {
        this._CAPI = CAPI;
    };

    /**
     * Set the credentials
     *
     * @method setCredentials
     * @param {Object} credentials
     * @param {String} credentials.login
     * @param {String} credentials.password
     */
    SessionAuthAgent.prototype.setCredentials = function (credentials) {
        this._login = credentials.login;
        this._password = credentials.password;
    };

    /**
     * Resets the storage associated with this auth agent
     *
     * @method _resetStorage
     * @protected
     */
    SessionAuthAgent.prototype._resetStorage = function () {
        this._storage.removeItem(SessionAuthAgent.KEY_SESSION_NAME);
        this._storage.removeItem(SessionAuthAgent.KEY_SESSION_ID);
        this._storage.removeItem(SessionAuthAgent.KEY_SESSION_HREF);
        this._storage.removeItem(SessionAuthAgent.KEY_CSRF_TOKEN);
    };

    /**
     * Stores the session information in the storage
     *
     * @method _storeSessionInfo
     * @param {Object} session an object describing the session
     * @param session.name {String} the name of the session
     * @param session.identifier {String} the identifier of the session
     * @param session.href {String} the resource uri to refresh the session
     * @param session.csrfToken {String} the CSRF Token associated with the
     * session
     * @protected
     */
    SessionAuthAgent.prototype._storeSessionInfo = function (session) {
        this._storage.setItem(SessionAuthAgent.KEY_SESSION_NAME, session.name);
        this._storage.setItem(SessionAuthAgent.KEY_SESSION_HREF, session.href);
        this._storage.setItem(SessionAuthAgent.KEY_SESSION_ID, session.identifier);
        this._storage.setItem(SessionAuthAgent.KEY_CSRF_TOKEN, session.csrfToken);
    };

    return SessionAuthAgent;
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
